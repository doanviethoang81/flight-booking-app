import { useState, useEffect } from "react";
import "./Header.css";
import {
  Avatar, Menu, MenuItem, Dialog, DialogTitle, DialogContent, TextField,
  Button, DialogActions, IconButton, InputAdornment, Divider
} from "@mui/material";
import EmailIcon from "@mui/icons-material/Email";
import LockIcon from "@mui/icons-material/Lock";
import Visibility from "@mui/icons-material/Visibility";
import VisibilityOff from "@mui/icons-material/VisibilityOff";
import PaidIcon from '@mui/icons-material/Paid';
import HistoryIcon from '@mui/icons-material/History';
import LogoutIcon from '@mui/icons-material/Logout';
import PermIdentityIcon from '@mui/icons-material/PermIdentity';
import logoWhite from "../../assets/images/traveloka-official-logo-resmi-white-new.webp";
import logoBlack from "../../assets/images/traveloka_logo.png";
import flag from "../../assets/images/Flag_of_Vietnam.svg.webp";
import chevronmore from "../../assets/icon/chevron-compact-down.svg";
import { Link, useNavigate } from "react-router-dom";
import axios from "axios";
import backgroundImage from "../../assets/images/imgResource.webp";
import ChangeCircleIcon from '@mui/icons-material/ChangeCircle';


const Header = () => {
  const [isScrolled, setIsScrolled] = useState(false);
  const [user, setUser] = useState(null);
  const [anchorEl, setAnchorEl] = useState(null);
  const [openLogin, setOpenLogin] = useState(false);
  const [openRegister, setOpenRegister] = useState(false);
  const [showPassword, setShowPassword] = useState(false);
  const [loginData, setLoginData] = useState({ email: "", password: "" });
  const [error, setError] = useState("");


  useEffect(() => {
    const handleScroll = () => {
      setIsScrolled(window.scrollY > 50);
    };
    window.addEventListener("scroll", handleScroll);
    return () => {
      window.removeEventListener("scroll", handleScroll);
    };

  }, []);


 // Kh√¥i ph·ª•c user t·ª´ localStorage khi load trang
useEffect(() => {
  const token = localStorage.getItem("token");
  const fullName = localStorage.getItem("fullname");
  const email = localStorage.getItem("email");

  if (token && fullName) {
      setUser({
          email: email || "",
          firstName: fullName,
          lastName: "",
          avatar: "",
          points: 100,
      });
  }
}, []);

// X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
const handleLogin = async () => {
  try {
      const response = await axios.post("http://localhost:8080/api/auth/login", loginData);
      console.log("D·ªØ li·ªáu t·ª´ BE:", response.data);
      if (response.data) {
          const { fullname, token, email } = response.data;
          setUser({
              email: email,
              firstName: fullname,
              lastName: "",
              avatar: "",
              points: 100,
          });
          localStorage.setItem("fullname", fullname);
          localStorage.setItem("token", token);
          localStorage.setItem("email", email);
          setOpenLogin(false);
          setError("");
          alert("ƒêƒÉng nh·∫≠p th√†nh c√¥ng!");
          navigate('/');
      } else {
          setError("L·ªói: Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ server!");
      }
  } catch (error) {
      console.error("L·ªói trong khi ƒëƒÉng nh·∫≠p:", error);
      const errorMsg = error.response.data || error.response.message || "C√≥ l·ªói x·∫£y ra!";
      setError(errorMsg);
      alert(errorMsg);
  }
};
const checkGoogleLogin = async (email) => {
  try {
    const response = await axios.get(`http://localhost:8080/api/v1/nguoi_dat/check-email/${email}`);
    const data = response.data;
    
    if (data.message === "B·∫°n ƒëƒÉng nh·∫≠p b·∫±ng Google n√™n c·∫ßn t·∫°o m·∫≠t kh·∫©u m·ªõi.") {
      navigate(`/user/new-password-user/${email}`, { state: { email } });
    } else if (data.message === "ƒê√£ c√≥ m·∫≠t kh·∫©u, chuy·ªÉn t·ªõi trang ƒë·ªïi m·∫≠t kh·∫©u.") {
      navigate(`/user/change-password-user/${email}`, { state: { email } });
    }
  } catch (error) {
    console.error("Error checking email:", error);
    setError(error.response?.data?.message || "C√≥ l·ªói khi ki·ªÉm tra email");
  }
};
  useEffect(() => {
    const queryParams = new URLSearchParams(window.location.search);
    const token = queryParams.get("token");
    const name = queryParams.get("name");
    const avatarurl = queryParams.get("avatar");
    const email = queryParams.get("email"); // Gi·∫£ s·ª≠ backend tr·∫£ v·ªÅ email
    const errorMessage = queryParams.get("error");
  
    if (token && name && avatarurl) {
      setUser({
        email: email || "", // L∆∞u email n·∫øu c√≥
        firstName: name,
        lastName: "",
        avatar: avatarurl,
        points: 100,
      });
      setOpenLogin(false);
      localStorage.setItem("fullname", name);
      localStorage.setItem("token", token);
      localStorage.setItem("email", email || ""); // L∆∞u email v√†o localStorage
    }
  
    if (errorMessage) {
      alert(errorMessage);
    }
    window.history.replaceState({}, "", window.location.pathname);
  }, []);


  const handleGoogleLogin = () => {

    window.location.href = 'http://localhost:8080/oauth2/authorization/google'

  };

  const [registerData, setRegisterData] = useState({
    fullName: "",
    email: "",
    password: ""
  });

  const navigate = useNavigate();
  async function handleRegister() {
    setError("");
    try {
      const response = await axios.post("http://localhost:8080/api/auth/register", registerData);
      setOpenRegister(false);
      const email = registerData.email;
      navigate("/verifyaccount", { state: { email } });
      alert(response.data);
    } catch (error) {
      console.error("L·ªói trong khi ƒëƒÉng k√Ω:", error);
      const errorMsg = error.response.data || error.response.message || "C√≥ l·ªói x·∫£y ra!";
      setError(errorMsg);
      alert(errorMsg);
    }
  }

  const handleLogout = () => {
    setUser(null);
    setAnchorEl(null);
    localStorage.removeItem("token");
    localStorage.removeItem("fullname");
    localStorage.removeItem("email"); // X√≥a email kh·ªèi localStorage
    window.location.href = '/'; 
  };

  const handleMenuClick = (event) => {
    setAnchorEl(event.currentTarget);
  };
  return (
    <header className={`header h-50 `}>
      <div
        className="w-full h-full bg-cover bg-center"
        style={{
          backgroundImage: `url(${backgroundImage})`,
        }}>
        <div className="header-top">
          <div className="logo cursor-pointer md:!pl-10" onClick={() => navigate('/')}>
            <img src={isScrolled ? logoBlack : logoWhite} alt="Logo" />
          </div>

          <div className="header-right md:!pr-10">
            <div className="user-actions">
              <div className="language-currency">
                <img src={flag} alt="VN Flag" />
                <span>VI | VND </span>
              </div>
              <div className="event-badge">üéâ Birthday Sale</div>
              <div className="event-badge ">H·ªó Tr·ª£ </div>
              <div className="event-badge ">H·ª£p T√°c V·ªõi Ch√∫ng T√¥i</div>
              <div className="event-badge ">ƒê·∫∑t ch·ªó c·ªßa t√¥i</div>

              {user ? (
                <>
                  <div className="user-profile" onClick={handleMenuClick}>
                    <Avatar alt={user.lastName} src={user.avatar} />
                    <span className="user-name ">{user.firstName} {user.lastName}</span>
                    <p>|</p>
                    <PaidIcon style={{ color: "gold", fontSize: "18px" }} /> {user.points} ƒêi·ªÉm
                  </div>
                  <Menu
                    anchorEl={anchorEl}
                    open={Boolean(anchorEl)}
                    onClose={() => setAnchorEl(null)}
                    PaperProps={{ style: { width: anchorEl ? anchorEl.getBoundingClientRect().width : "auto" } }}
                    disableScrollLock
                  >
                   <MenuItem  onClick={() => navigate("/thongtinuser")}> <PermIdentityIcon style={{ paddingRight: "20px", fontSize: "2.5rem" }} /> Th√¥ng Tin Kh√°ch H√†ng</MenuItem>

                    <MenuItem onClick={() => alert("Trang L·ªãch S·ª≠ Mua V√©")}><HistoryIcon style={{ paddingRight: "20px",fontSize: "2.5rem" }} />  L·ªãch S·ª≠ Mua V√© </MenuItem>
                    <MenuItem onClick={async () => { if (user && user.email) { await checkGoogleLogin(user.email); } else { alert("Kh√¥ng t√¨m th·∫•y email ng∆∞·ªùi d√πng!"); } }}>
                         <ChangeCircleIcon style={{ paddingRight: "20px", fontSize: "2.5rem" }} /> ƒê·ªïi M·∫≠t Kh·∫©u
                   </MenuItem>
                    <MenuItem onClick={handleLogout}><LogoutIcon style={{ paddingRight: "20px",fontSize: "2.5rem" }} />ƒêƒÉng xu·∫•t</MenuItem>
                  </Menu>
                </>
              ) : (
                <>
                  <button className="login " onClick={() => setOpenLogin(true)}>ƒêƒÉng Nh·∫≠p</button>
                  <button className="register " onClick={() => setOpenRegister(true)}>ƒêƒÉng k√Ω</button>
                </>
              )}
            </div>
          </div>
        </div>

        <div className="nav-container md:!pl-10 md:!pr-10">
          <nav className="nav-links !w-full">
            <ul className="w-full justify-between">
              <li><Link to="/blog">Blog</Link></li>
              <li><a className="md:text-sm" href="/flights">V√© m√°y bay</a></li>
              <li><a className="md:text-sm" href="/bus-tickets">V√© xe kh√°ch</a></li>
              <li><a className="md:text-sm" href="/airport-transfer">ƒê∆∞a ƒë√≥n s√¢n bay</a></li>
              <li><a className="md:text-sm" href="/car-rental">Cho thu√™ xe</a></li>
              <li><a className="md:text-sm" href="/activities">Ho·∫°t ƒë·ªông & Vui ch∆°i</a></li>
              <li><Link to="/informationCustomer">Tra c·ª©u</Link></li>

              <li><a className="md:text-sm" href="/more">More <img src={chevronmore} alt="more" /></a></li>
            </ul>
          </nav>
        </div>
      </div>


      {/* H·ªôp tho·∫°i ƒêƒÉng Nh·∫≠p */}
      <Dialog open={openLogin} onClose={() => setOpenLogin(false)} maxWidth="xs" fullWidth disableScrollLock>

        <DialogTitle>ƒêƒÉng Nh·∫≠p</DialogTitle>
        <DialogContent>
          <TextField
            label="Email"
            fullWidth
            margin="dense"
            value={loginData.email}
            onChange={(e) => setLoginData({ ...loginData, email: e.target.value })}
            InputProps={{ startAdornment: <InputAdornment position="start"><EmailIcon /></InputAdornment> }}
            error={Boolean(error)}
          />

          <TextField
            label="M·∫≠t kh·∫©u"
            type={showPassword ? "text" : "password"}
            fullWidth
            margin="dense"
            value={loginData.password}
            onChange={(e) => setLoginData({ ...loginData, password: e.target.value })}
            InputProps={{
              startAdornment: <InputAdornment position="start"><LockIcon /></InputAdornment>,
              endAdornment: (
                <InputAdornment position="end">
                  <IconButton onClick={() => setShowPassword(!showPassword)}>
                    {showPassword ? <VisibilityOff /> : <Visibility />}
                  </IconButton>
                </InputAdornment>
              ),
            }}
            error={Boolean(error)}
            helperText={error}
          />
          <Button fullWidth variant="contained" color="primary" onClick={handleLogin} sx={{ mt: 2 }}>
            ƒêƒÉng Nh·∫≠p
          </Button>
          <Divider sx={{ my: 2 }}>Ho·∫∑c</Divider>
          <button onClick={handleGoogleLogin} className="w-full flex items-center justify-center border border-gray-300 bg-white text-black font-medium py-2 rounded-lg shadow-sm hover:bg-gray-100 transition-all">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/768px-Google_%22G%22_logo.svg.png"
              alt="Google logo"
              className="w-5 h-5 mr-2"
            /> ƒêƒÉng nh·∫≠p v·ªõi Google
          </button>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpenLogin(false)}>H·ªßy</Button>
        </DialogActions>
      </Dialog>


      <Dialog open={openRegister} onClose={() => setOpenRegister(false)} maxWidth="xs" fullWidth disableScrollLock>
        <DialogTitle>ƒêƒÉng K√Ω</DialogTitle>
        <DialogContent>
          <TextField
            label="H·ªç v√† T√™n"
            fullWidth
            margin="dense"
            value={registerData.fullName}
            onChange={(e) => setRegisterData({ ...registerData, fullName: e.target.value })}
          />

          <TextField
            label="Email"
            fullWidth
            margin="dense"
            value={registerData.email}
            onChange={(e) => setRegisterData({ ...registerData, email: e.target.value })}
          />

          <TextField
            label="M·∫≠t kh·∫©u"
            type="password"
            fullWidth
            margin="dense"
            value={registerData.password}
            onChange={(e) => setRegisterData({ ...registerData, password: e.target.value })}
          />
        </DialogContent>

        <DialogActions>
          <Button onClick={() => setOpenRegister(false)}>H·ªßy</Button>
          <Button variant="contained" color="primary" onClick={handleRegister}>ƒêƒÉng K√Ω</Button>
        </DialogActions>
      </Dialog>

    </header>
  );
};

export default Header;


